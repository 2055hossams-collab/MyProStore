<%- include('partials/header', {title: 'ุฅุชูุงู ุนูููุฉ ุงูุฏูุน'}) %>

<div class="container my-5">
    <h2 class="text-center mb-4">๐ณ ุฅุชูุงู ุนูููุฉ ุงูุฏูุน</h2>
    <hr>
    
    <% if (!cart || cart.length === 0) { %>
        <div class="alert alert-warning text-center">
            ูุง ุชูุฌุฏ ุนูุงุตุฑ ูู ุงูุนุฑุจุฉ ูููุชุงุจุนุฉ ุฅูู ุงูุฏูุน. <a href="/">ุงูุนูุฏุฉ ูููุชุฌุฑ</a>
        </div>
        <%- include('partials/footer') %>
        <% return %>
    <% } %>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm p-4">
                <h4 class="mb-4 text-primary"><i class="fas fa-truck me-2"></i> ูุนูููุงุช ุงูุดุญู</h4>
                <form action="/checkout" method="POST">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="fullName" class="form-label">ุงูุงุณู ุจุงููุงูู</label>
                            <input type="text" class="form-control" id="fullName" name="fullName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                            <input type="email" class="form-control" id="email" name="email" value="<%= user ? user.username : '' %>" required readonly>
                        </div>
                        <div class="col-12">
                            <label for="address" class="form-label">ุงูุนููุงู ุงูุชูุตููู</label>
                            <input type="text" class="form-control" id="address" name="address" placeholder="ุงูุดุงุฑุนุ ุฑูู ุงูููุฒูุ ุชูุงุตูู ุฅุถุงููุฉ" required>
                        </div>
                        <div class="col-md-4">
                            <label for="city" class="form-label">ุงููุฏููุฉ</label>
                            <input type="text" class="form-control" id="city" name="city" required>
                        </div>
                        <div class="col-md-4">
                            <label for="country" class="form-label">ุงูุฏููุฉ</label>
                            <input type="text" class="form-control" id="country" name="country" value="ุงูุณุนูุฏูุฉ" required>
                        </div>
                        <div class="col-md-4">
                            <label for="zip" class="form-label">ุงูุฑูุฒ ุงูุจุฑูุฏู</label>
                            <input type="text" class="form-control" id="zip" name="zip" required>
                        </div>
                        <div class="col-md-6">
                            <label for="phone" class="form-label">ุฑูู ุงููุงุชู</label>
                            <input type="tel" class="form-control" id="phone" name="phone" required placeholder="ูุซุงู: 05XXXXXXXX">
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h4 class="mb-3 text-primary"><i class="fas fa-wallet me-2"></i> ุทุฑููุฉ ุงูุฏูุน (ุงูุชุฑุงุถู)</h4>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="cashOnDelivery" value="Cash On Delivery" checked>
                        <label class="form-check-label" for="cashOnDelivery">
                            ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู (COD)
                        </label>
                    </div>
                    <button type="submit" class="btn btn-success btn-lg w-100 mt-5">
                        ุฅุชูุงู ุงูุทูุจ ูุงูุฏูุน 
                    </button>
                </form>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white fw-bold"><i class="fas fa-file-invoice me-2"></i> ููุฎุต ุงููุงุชูุฑุฉ</div>
                <div class="card-body">
                    <% 
                        let subtotal = 0;
                        let discount = 0;
                        cart.forEach(item => subtotal += item.price * item.qty);

                        if (coupon) {
                            if (coupon.type === 'fixed') {
                                discount = coupon.value;
                            } else if (coupon.type === 'percentage') {
                                discount = subtotal * (coupon.value / 100);
                            }
                            discount = Math.min(discount, subtotal); 
                        }
                        const finalTotal = subtotal - discount;
                    %>
                    
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item d-flex justify-content-between small text-muted">
                            <span>ุงูุฅุฌูุงูู ุงููุฑุนู (<%= cart.length %> ุฃุตูุงู):</span>
                            <span><%= subtotal.toFixed(2) %> ุฑ.ุณ</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between small text-success">
                            <span>ุงูุฎุตู (<%= coupon ? coupon.code : 'ูุง ููุฌุฏ' %>):</span>
                            <span>- <%= discount.toFixed(2) %> ุฑ.ุณ</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between small">
                            <span>ุชูููุฉ ุงูุดุญู (ุงูุชุฑุงุถู):</span>
                            <span>ูุฌุงูู</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between fw-bold fs-5 bg-light">
                            <span>ุงูุฅุฌูุงูู ุงูููุงุฆู:</span>
                            <span class="text-danger"><%= finalTotal.toFixed(2) %> ุฑ.ุณ</span>
                        </li>
                    </ul>
                    
                    <h6 class="mt-4 mb-2">ุงูููุชุฌุงุช ูู ุงูุนุฑุจุฉ:</h6>
                    <ul class="list-group list-group-flush">
                        <% cart.forEach(item => { %>
                            <li class="list-group-item d-flex justify-content-between p-1 small">
                                <span class="text-truncate"><%= item.name %></span>
                                <span>x <%= item.qty %></span>
                            </li>
                        <% }) %>
                    </ul>
                    
                </div>
            </div>
        </div>
    </div>
</div>

<%- include('partials/footer') %>
